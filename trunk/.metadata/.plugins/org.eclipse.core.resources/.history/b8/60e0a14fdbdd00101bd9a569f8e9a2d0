/*
 * gqandroidsphinx.cpp
 *
 *  Created on: 2011-9-13
 *      Author: root
 */

#include <gqandroidsphinx.h>

#include <stdlib.h>

#include <pocketsphinx.h>

GqAndroidSphinx::GqAndroidSphinx() :
		m_shmm("/data/td/model/hmm/"), m_slm(
				"/data/td/model/lm/zh_broadcastnews_64000_utf8.DMP"), m_sdict(
				"/data/td/model/lm/zh_broadcastnews_utf8.dic") {

}

GqAndroidSphinx::~GqAndroidSphinx() {
	// TODO Auto-generated destructor stub
}

bool GqAndroidSphinx::init_sphinx() {
	m_pconfig = cmd_ln_init(NULL, ps_args(), TRUE, "-hmm",
			m_shmm.c_str(), "-lm",
			m_slm.c_str(), "-dict",
			m_sdict.c_str(), NULL);
	if (m_pconfig == NULL) {
		return false;
	}

	if (m_pdecoder) {
		ps_free(m_pdecoder);
		m_pdecoder = NULL;
	}

	m_pdecoder = ps_init(m_pconfig);
	if (m_pdecoder == 0) {
		return false;
	}

	FILE *fh;
	fh = fopen("/data/td/sound/aaa.wav", "rb");
	if (fh == 0) {
		perror("failed to open goforward.raw");
		return 1;
	}

	printf("ps_decode_raw 1: \n\n\n\n\n");

	int rv = ps_decode_raw(ps, fh, "goforward_t", -1);
	if (rv < 0) {
		return 1;
	}

	char const *hyp, *uutid;
	int32 score;
	hyp = ps_get_hyp(ps, &score, &uutid);
	if (hyp == NULL) {
		return 1;
	}

	printf("recognized: %s\n", hyp);

	return true;
}

